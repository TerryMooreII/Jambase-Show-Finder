<!-----------------------------------------------------------------------------
Application: Jambase Concert Lookup
Date: 9/11/2010
Written By: Terry Moore 
  Email: motersho@gmail.com 
  Website: www.motersho.com
Desc: Adds a popup icon to Google Chrome for quick access
      to find local jmband concerts in your area via Jambase.com
------------------------------------------------------------------------------>


<html>
<head>

<link rel="stylesheet" href="css/ui-lightness/jquery-ui-1.8.4.custom.css" type="text/css" media="all" /> 
<link rel="stylesheet" href="css/jambase.css" type="text/css" media="all" /> 
<script type="text/javascript" charset="utf-8" src="js/jquery-1.4.1.min.js"></script>
<script type="text/javascript" charset="utf-8" src="js/jquery-ui-1.8.4.custom.min.js"></script>
<script type="text/javascript" charset="utf-8" src="js/json2.js"></script>

</head>
<body>
  <div id="wrapper"> <!--Wrapper is used to specify the pop window size-->   
    <div id="header">
      <h1>Jambase Show Finder</h1>
    </div>
    <div id="menu">
    <center><table>
    <form id="lookup" name="lookup" method="get" action="">
    <input type="hidden" name="user" id="user">
        <tr>
          <td class="header">City or<br />Zipcode:</td>
          <td class="option"><input type="input" name="city" id="city" size="18" tabindex=1 onkeydown="if (event.keyCode == 13) document.getElementById('submit').click()"></td>
          <td class="header">Band:</td>
          <td class="option"><input type="input" name="band" id="band" size="15" tabindex=3 onkeydown="if (event.keyCode == 13) document.getElementById('submit').click()"></td>
          <td class="header">From:</td>
          <td class="option"><input type="input" name="startDate" id="startDate" size="10" tabindex=5></td>
          <td align="right" valign="top">
           <img src="img/reset.png" alt="Options" title="Reset Form" id="clearForms">
            <a href="#" onclick="bkg.openurl('options.html')"><img src="img/tool2.jpg" alt="Options" title="Options" height="22" width="22"></a> </td>
        </tr>
        <tr>
          <td class="header">State:</td>
          <td class="option"><select name="state" id="state" tabindex=2>
                <option value=""></option> 
                <option value="AL">Alabama</option> 
                <option value="AK">Alaska</option> 
                <option value="AB">Alberta</option> 
                <option value="AZ">Arizona</option> 
                <option value="AR">Arkansas</option> 
                <option value="BC">British Columbia</option> 
                <option value="CA">California</option> 
                <option value="CO">Colorado</option> 
                <option value="CT">Connecticut</option> 
                <option value="DE">Delaware</option> 
                <option value="DC">District of Columbia</option> 
                <option value="FL">Florida</option> 
                <option value="GA">Georgia</option> 
                <option value="HI">Hawaii</option> 
                <option value="ID">Idaho</option> 
                <option value="IL">Illinois</option> 
                <option value="IN">Indiana</option> 
                <option value="IA">Iowa</option> 
                <option value="KS">Kansas</option> 
                <option value="KY">Kentucky</option> 
                <option value="LA">Louisiana</option> 
                <option value="ME">Maine</option> 
                <option value="MB">Manitoba</option> 
                <option value="MD">Maryland</option> 
                <option value="MA">Massachusetts</option> 
                <option value="MI">Michigan</option> 
                <option value="MN">Minnesota</option> 
                <option value="MS">Mississippi</option> 
                <option value="MO">Missouri</option> 
                <option value="MT">Montana</option> 
                <option value="NE">Nebraska</option> `
                <option value="NV">Nevada</option> 
                <option value="NB">New Brunswick</option> 
                <option value="NH">New Hampshire</option> 
                <option value="NJ">New Jersey</option> 
                <option value="NM">New Mexico</option> 
                <option value="NY">New York</option> 
                <option value="NF">Newfoundland</option> 
                <option value="NC">North Carolina</option> 
                <option value="ND">North Dakota</option> 
                <option value="NT">Northwest Territories</option> 
                <option value="NS">Nova Scotia</option> 
                <option value="OH">Ohio</option> 
                <option value="OK">Oklahoma</option> 
                <option value="ON">Ontario</option> 
                <option value="OR">Oregon</option> 
                <option value="PA">Pennsylvania</option> 
                <option value="PE">Prince Edward Island</option> 
                <option value="QC">Quebec</option> 
                <option value="RI">Rhode Island</option> 
                <option value="SK">Saskatchewan</option> 
                <option value="SC">South Carolina</option> 
                <option value="SD">South Dakota</option> 
                <option value="TN">Tennessee</option> 
                <option value="TX">Texas</option> 
                <option value="UT">Utah</option> 
                <option value="VT">Vermont</option> 
                <option value="VA">Virginia</option> 
                <option value="WA">Washington</option> 
                <option value="WV">West Virginia</option> 
                <option value="WI">Wisconsin</option> 
                <option value="WY">Wyoming</option> 
                <option value="YT">Yukon</option> 
                <option value="---"></option> 
                <option value="ARG">Argentina</option> 
                <option value="AU">Australia</option> 
                <option value="AUS">Austria</option> 
                <option value="BS">Bahamas</option> 
                <option value="BH">Bahrain</option> 
                <option value="BEL">Belgium</option> 
                <option value="BZ">Belize</option> 
                <option value="BMD">Bermuda</option> 
                <option value="BA">Bosnia and Herzegovina</option> 
                <option value="BR">Brazil</option> 
                <option value="BG">Bulgaria</option> 
                <option value="CL">Chile</option> 
                <option value="CN">China</option> 
                <option value="COL">Colombia</option> 
                <option value="CR">Costa Rica</option> 
                <option value="HR">Croatia</option> 
                <option value="CZ">Czech Republic</option> 
                <option value="DK">Denmark</option> 
                <option value="DR">Dominican Republic</option> 
                <option value="EC">Ecuador</option> 
                <option value="EE">Estonia </option> 
                <option value="ET">Ethiopia</option> 
                <option value="FO">Faroe Islands</option> 
                <option value="FJ">Fiji</option> 
                <option value="FI">Finland</option> 
                <option value="FRA">France</option> 
                <option value="GE">Georgia (country)</option> 
                <option value="GER">Germany</option> 
                <option value="GH">Ghana</option> 
                <option value="GR">Greece</option> 
                <option value="GU">Guam</option> 
                <option value="HU">Hungary</option> 
                <option value="IS">Iceland</option> 
                <option value="INA">India</option> 
                <option value="IND">Indonesia</option> 
                <option value="IR">Ireland</option> 
                <option value="IRL">Israel</option> 
                <option value="IT">Italy</option> 
                <option value="JM">Jamaica</option> 
                <option value="JP">Japan</option> 
                <option value="KZ">Kazakhstan</option> 
                <option value="LV">Latvia</option> 
                <option value="LB">Lebanon</option> 
                <option value="LI">Liechtenstein</option> 
                <option value="LT">Lithuania </option> 
                <option value="LU">Luxembourg </option> 
                <option value="MY">Malaysia</option> 
                <option value="MX">Mexico</option> 
                <option value="MC">Monaco</option> 
                <option value="MOR">Morocco</option> 
                <option value="NL">Netherlands</option> 
                <option value="NZ">New Zealand</option> 
                <option value="NG">Nigeria</option> 
                <option value="NO">Norway</option> 
                <option value="PAN">Panama</option> 
                <option value="PER">Peru</option> 
                <option value="PH">Philippines</option> 
                <option value="PL">Poland</option> 
                <option value="POR">Portugal</option> 
                <option value="PR">Puerto Rico</option> 
                <option value="RO">Romania</option> 
                <option value="RUS">Russia</option> 
                <option value="ws">Samoa</option> 
                <option value="SN">Senegal</option> 
                <option value="RS">Serbia</option> 
                <option value="SG">Singapore</option> 
                <option value="SKR">Slovak Republic</option> 
                <option value="SI">Slovenia</option> 
                <option value="ZA">South Africa</option> 
                <option value="KR">South Korea</option> 
                <option value="ES">Spain</option> 
                <option value="SE">Sweden</option> 
                <option value="SWI">Switzerland</option> 
                <option value="TH">Thailand</option> 
                <option value="TT">Trinidad &amp; Tobago</option> 
                <option value="TR">Turkey</option> 
                <option value="UA">Ukraine</option> 
                <option value="UAE">United Arab Emirates</option> 
                <option value="GB">United Kingdom</option> 
                <option value="UY">Uruguay</option> 
                <option value="VE">Venezuela</option> 
                <option value="VN">Vietnam</option> 
                <option value="VI">Virgin Islands</option> 
              </select>
          </td>
          <td class="header">Radius:</td>
          <td class="option"> <select class="radius" name="radius" id="radius" tabindex=4>
            <option value=""></option>
            <option value="0">City Limits</option>
            <option value="25">25 miles</option>
            <option value="50">50 miles</option>
            <option value="75">75 miles</option>
            <option value="100">100 miles</option>
            </select>
          </td>
          <td class="header">To:</td>
          <td class="option"><input type="input" name="endDate" id="endDate" size="10" tabindex=6></td>
          <td> 
              <input type="button" value="Find" id="submit" tabindex=8 onclick="getShowData(lookup.startDate.value,
                                                                                lookup.endDate.value,
                                                                                lookup.city.value,
                                                                                lookup.state.value,
                                                                                lookup.radius.value,
                                                                                lookup.band.value, 
                                                                                '', 
                                                                                '')">
          </td>
        </tr>
    </form>
  </table>
  </div>
  <div id="showHeader"> 
    <table border="0"><tr><th width="217">Artist</th><th width="140">Venue</th><th width="130">Location</th><th></th><th></th></tr></table>
  </div>
  <div id="showinfo">  
    <div id="loading"></div>
  </div>

  <div id="footer">
		Written By:
		<a href="http://www.motersho.com" onclick="bkg.openurl('http://www.motersho.com')">Terry Moore</a> <br />
    Concert Information provided by: <br />
    <a href="#" onclick="bkg.openurl('http://www.jambase.com')" title="JamBase Concert Search">
    <img src= "img/jambase140x70.gif" alt="Search JamBase Concerts" border="0" /></a>

	</div>
<!--<div id="msg"></div>-->
  </div> 
<script type="text/javascript" charset="utf-8">

//Grap the chrome backgound page so that we can load <a> 
var bkg = chrome.extension.getBackgroundPage();
var optionsPage = chrome.extension.getURL('/options.html');

//Specify dates for calendar
var date1 = new Date();
var m = date1.getMonth(), d = date1.getDate(), y = date1.getFullYear();

//Set Option from extension options
$(document).ready(function(){
  document.getElementById('city').value = window.localStorage.getItem("city");
  document.getElementById('state').value = window.localStorage.getItem("state");
  document.getElementById('radius').value = window.localStorage.getItem("radius");
  document.getElementById('band').value = window.localStorage.getItem("band");
  document.getElementById('user').value = window.localStorage.getItem("user");
  getShowData(lookup.startDate.value,
              lookup.endDate.value,
              lookup.city.value,
              lookup.state.value,
              lookup.radius.value,
              lookup.band.value, 
              '', //venue
              lookup.user.value)
});



$("#clearForms").click(function(){
  document.getElementById('city').value = "";
  document.getElementById('state').value = "";
  document.getElementById('radius').value = "";
  document.getElementById('band').value = "";
  document.getElementById('user').value = "";
  document.getElementById('startDate').value = "";
  document.getElementById('endDate').value = "";
});



$(function() {
	  $( "#startDate" ).datepicker();
    $( "#startDate" ).datepicker( "option", "minDate", new Date(y, m, d) );    
    $( "#startDate" ).datepicker( "option", "changeMonth", true );
    $( "#startDate" ).datepicker( "option", "changeYear", true );
  });
$(function() {
	  $( "#endDate" ).datepicker();
    $( "#endDate" ).datepicker( "option", "minDate", new Date(y, m, d) );
    $( "#endDate" ).datepicker( "option", "changeMonth", true );
    $( "#endDate" ).datepicker( "option", "changeYear", true );
  });

String.prototype.capitalize = function(){
   return this.replace( /(^|\s)([a-z])/g , function(m,p1,p2){ return p1+p2.toUpperCase(); } );
  };

function isInt(x) { 
   var y=parseInt(x); 
   if (isNaN(y)) return false; 
   return x==y && x.toString()==y.toString(); 
 } 



function getShowData(startDate, endDate,city,state,radius,band,venue,user){

 // if (!zip) { zip = ''; }
  if (!startDate) { startDate = ''; }
  if (!endDate) { endDate = ''; }
  if (!radius) { radius = ''; }
  if (!band) { band = ''; }
  if (!user) { user = ''; }
  if (!city) { city = ''; }
  if (!state) { state = ''; }
  if (!venue) { venue = ''; }
  
  //Set the value of the input boxes.  Need for when a user clicks on a link
  document.getElementById("city").value = city;  
  document.getElementById("state").value = state;
  document.getElementById("radius").value = radius;
  document.getElementById("band").value = band;
  document.getElementById("user").value = user;

  apiurl = 'http://api.jambase.com/search?';
  apikey = 'apikey=' + 'rp2bnuy7dwhbch2gxarqxxz2';

  //if (zip !='') {zip  = '&zip=' + zip;}
  if (radius !='') {radius = '&radius=' + radius;}
  if (startDate !='') {
    if(endDate == '') { endDate = '12/31/2020'} //Fix possible bug in Jambase API
    startDate = '&startDate=' + startDate;
  }
  if (endDate !='') {endDate = '&endDate=' + endDate;}
  if (band !='') {band = '&band=' + band;}
  if (user !='') {user = '&user='+ user;}
  if (city !='') {
    if (isInt(city)) {
      city  = '&zip=' + city;
    }else{
      city = '&City=' + city.capitalize();
    }
  }
  if (state !='') {state = '&State='+ state;}
  if (venue !='') {venue = '&VenueID='+ venue;}

  url = apiurl + apikey + radius + startDate  + endDate + band  + city + state + venue + user;
    $('#msg').html(url + '<br>').show();
  $(document).ready(function()
  {
    $.ajax({
      type: "GET",
      url: url,
      dataType: "xml",
      beforeSend: function() { 
          $('#showinfo').html('<center><span class="loading"><img src="img/loading.gif" alt="loading" /></span></center>').show(); 
      },
      complete: function() { $('.showinfo').html('').show(); },
      success: parseXml,
      timeout: 7000,
      error: ajaxError /*function(){ $('#showinfo').html('<center>Either there was an error or no data</center>').show(); }*/
    });
  });
}

function ajaxError(request,status,error){

  elm = 'Request: ' + request + '<br />' +
        'Status: ' + status + '<br />' +
        'Error: ' + error;
   $('#showinfo').html(elm).show();
}

var artist_name=''; //needed as a global for show w/ multiple artists.
function parseXml(xml){
 
  var x = 0;
  var display_date='';
  var compare_date='';
  var date;
  var elm = '<center> <table class="upcoming">';
  

  $(xml).find("event").each(function()
  {
  
    date = $(this).find('event_date').text();
    if (compare_date == date ) {
      display_date = '';
    }else{
      display_date = '<tr><th style="border:0px #fff" colspan="5"<span class="date">'  + date +'</span></td></tr>';
      compare_date = date;
    }
   
    //var artist_name = $(this).find('artist_name').text();
    artist_name = '';
    $(this).find("artist").each(function(){
   
        var artist_esc_quote = $(this).find('artist_name').text().replace(/\'/g,'\\\'')            
        var artist_for_url = artist_esc_quote.replace(/ /gi, "-");
        
        
        var artist_url_external = 'http://www.jambase.com/Artists/' + $(this).find('artist_id').text() + '/' + artist_for_url
        
        artist_url_external = '<a href="#" onclick="bkg.openurl(\'' + artist_url_external+ '\')"><img src="img/ExternalLinkIcon.gif" title="Jambase\'s Artist Site" height="10" width="10">'

        artist_name = artist_name + '<a href="#" onclick="getShowData(\'\',\'\',\'\',\'\',\'\',\'' + artist_esc_quote  +'\',\'\')">' + $(this).find('artist_name').text()  + '</a>' +
                                     '<sup>' + artist_url_external +'</sup><br>';
      
    });

    var venue_name = $(this).find('venue_name').text();
    var venue_id = $(this).find('venue_id').text();
    var venue_city = $(this).find('venue_city').text();
    var venue_state = $(this).find('venue_state').text();
    var venue_zip = $(this).find('venue_zip').text();
    var event_url = $(this).find('event_url').text();
    
    var ticket_url = $(this).find('ticket_url').text();
    if (!ticket_url) { 
        var ticket_a_tag = ''; 
    }else{
        var ticket_a_tag = '<a href="#" onclick="bkg.openurl(\'' + ticket_url + '\')"><img src="img/tix.gif" title="Tickets"></a>'
    }
    
    //Not currently use.  For possible additions later.
    var city_url = 'http://www.jambase.com/shows/Shows.aspx?City=' + venue_city;
    var state_url = 'http://www.jambase.com/shows/Shows.aspx?State=' + venue_state;
    var venue_url = 'http://www.jambase.com/shows/Shows.aspx?VenueID=' + venue_id;
    //end Not Used    

    //Order of getShowData Parameters - For reference below
    //startDate, endDate,city,state,radius,band,venue,user
    
    elm = elm +  display_date +  
          '<tr>' +
          '<td width="200"><span class="artist_name">'  + artist_name + '</span></td>' +
          '<td width="125"><a href="#" onclick="getShowData(\'\',\'\',\'\',\'\',\'\',\'\',' + venue_id  +')">' + venue_name + '</a></td>' +
          '<td width="125"><a href="#" onclick="getShowData(\'\',\'\',\'' + venue_city  + '\',\'\',\'\',\'\',\'\')">' + venue_city + '</a>, ' + 
                            '<a href="#" onclick="getShowData(\'\',\'\',\'\',\'' + venue_state  +'\',\'\',\'\',\'\')">' + venue_state + '</td>' + 
          '<td width="25">' + ticket_a_tag + '</td>' + 
          '<td width="25"><a href="#" onclick="bkg.openurl(\'' + event_url + '\')"><img src="img/info.gif" title="More Info" height="16" width="16"></a></td>' + 
          '</tr>';

  });

  elm = elm + '</table> </center>';


  //Find and display errors returned from the API
  $(xml).find("errorNode").each(function()
  {
 
    var custom_err_msg = '';
    var error = $(this).text();
 
    if (error) {
      if (error == 'Too many shows found') {
        custom_err_msg = '<br /><br />' + 'To avoid the message either narrow down your search' + '<br />' +
                  'or click the options icon '+ 
                   '<a href="#" onclick="bkg.openurl(\'options.html\')"><img src="img/tool2.jpg" alt="Options" title="Options" height="22" width="22"></a> to specify your default search parameters';
      }
 
      if (error == 'Band not found'){
        custom_err_msg = '<br /><br />' + 'You must specify the full band name' + '<br />' +
                  '<a href="#" onclick="bkg.openurl(\'http://www.jambase.com/Artists/\')">Click here to search Jambase for the exact band name</a>';
      }
      elm = '<br /><center><span class="error">' + error + '</span>' + custom_err_msg + '</center>';
    }

  });


  $('#showinfo').html(elm).show();
}


</script>
</body>
</html>
